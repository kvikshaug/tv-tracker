{% load grouper %}

<div class="active-series">
  {% for group in active_series|grouper:4 %}
    <div class="row">
      {% for watching in group %}
        <div class="col-md-3">
          <div class="series">
            <a href="{% url 'core:watching' watching.id %}">
              <img class="poster" src="http://thetvdb.com/banners/{{ watching.series.poster }}">
            </a>

            <p class="title">
              {{ watching.series.name }}
              <a
                class="pull-right"
                title="Stop watching for now"
                href="{% url 'core:watching_status' watching.id %}?status=default">
                <i class="glyphicon glyphicon-remove"></i>
              </a>

            </p>
            <p class="next">
              {% if watching.unseen_available.count > 0 %}
                Next episode: {{ watching.unseen_available.first.episode_number }}
                ({{ watching.unseen_available.count }} left)
              {% else %}
                {# None available, then we want to know if something's about to air #}

                {% if not watching.series.has_next_episode_on_air and watching.series.status|lower == 'ended' %}
                  Series has ended
                {% else %}
                  {% if not watching.series.has_next_episode_on_air %}
                    Next episode TBA (seen: {{ watching.last_seen }})
                  {% else %}
                    Next episode: {{ watching.series.next_episode_on_air.episode_number }}
                    (airs in {{ watching.series.next_episode_on_air.days_remaining }} days)
                  {% endif %}
                {% endif %}

              {% endif %}
            </p>
            <p class="input">
              {% if watching.unseen_available.count > 0 %}
                <a href="{% url 'core:watching_seen' watching.id %}?increment">Watch</a>
              {% endif %}
              {% if watching.unseen_available.count > 0 and watching.has_last_seen %}
                or
              {% endif %}
              {% if watching.has_last_seen %}
                <a href="{% url 'core:watching_seen' watching.id %}?decrement">Forget</a>
              {% endif %}
            </p>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>
